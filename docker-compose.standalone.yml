version: '3.8'

services:
  insightone:
    image: insightone:latest
    build:
      context: .
      dockerfile: Dockerfile.standalone
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/insightone
      - NEXTAUTH_URL=http://localhost:${PORT:-3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-change-me-in-production}
      - AI_PROVIDER=${AI_PROVIDER:-local}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}
      - GITHUB_ID=${GITHUB_ID:-}
      - GITHUB_SECRET=${GITHUB_SECRET:-}
      - REPO_PATH=/app/repo
    volumes:
      - .:/app/repo:ro  # Mount current directory as the repository
    depends_on:
      - db
    restart: unless-stopped
    # Wait for DB to be ready, then generate Prisma client and apply migrations before starting
    command: sh -c "until pg_isready -h db -p 5432; do echo 'waiting for db...'; sleep 1; done; bunx prisma migrate deploy && bun run server.js"

  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=insightone
    ports:
      - "5432:5432"
    volumes:
      - insightone-standalone-db:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  insightone-standalone-db:
